{"version":3,"sources":["../src/EnvelopedData.js"],"names":["EnvelopedData","constructor","parameters","version","defaultValues","originatorInfo","recipientInfos","encryptedContentInfo","unprotectedAttrs","fromSchema","schema","memberName","OriginatorInfo","EncryptedContentInfo","Error","compareWithDefault","memberValue","certs","certificates","length","crls","contentType","contentEncryptionAlgorithm","encryptedContent","names","asn1js","Sequence","name","blockName","value","Integer","Constructed","optional","idBlock","tagClass","tagNumber","valueBlock","Set","Repeated","RecipientInfo","Attribute","asn1","compareSchema","verified","result","valueDec","Array","from","element","toSchema","outputArray","push","toJSON","_object","addRecipientByCertificate","certificate","variant","encryptionParameters","subjectPublicKeyInfo","algorithm","algorithmId","indexOf","oaepHashAlgorithm","kdfAlgorithm","kekEncryptionLength","oaepOID","hashOID","hashAlgorithm","AlgorithmIdentifier","algorithmParams","Null","rsaOAEPParams","RSAESOAEPParams","maskGenAlgorithm","keyInfo","KeyTransRecipientInfo","rid","IssuerAndSerialNumber","issuer","serialNumber","keyEncryptionAlgorithm","recipientCertificate","encryptedKey","RecipientEncryptedKey","KeyAgreeRecipientIdentifier","aesKWoid","aesKW","ecdhOID","kdf","ukmBuffer","ArrayBuffer","ukmView","Uint8Array","KeyAgreeRecipientInfo","ukm","OctetString","valueHex","recipientEncryptedKeys","RecipientEncryptedKeys","encryptedKeys","addRecipientByPreDefinedData","preDefinedData","byteLength","keyIdentifierBuffer","keyIdentifierView","keyIdentifier","hmacHashAlgorithm","iterationCount","keyEncryptionAlgorithmParams","kekOID","KEKRecipientInfo","kekid","KEKIdentifier","preDefinedKEK","pbkdf2OID","saltBuffer","saltView","hmacOID","hash","pbkdf2Params","PBKDF2Params","salt","prf","PasswordRecipientinfo","keyDerivationAlgorithm","password","encrypt","contentToEncrypt","sequence","Promise","resolve","ivBuffer","ivView","contentView","sessionKey","exportedSessionKey","recipientsPromises","_this","contentEncryptionOID","reject","crypto","then","generateKey","iv","error","exportKey","SubKeyAgreeRecipientInfo","index","currentSequence","ecdhPublicKey","ecdhPrivateKey","recipientCurve","recipientCurveLength","exportedECDHPublicKey","curveObject","ObjectIdentifier","curveOID","toString","namedCurve","publicKey","privateKey","getPublicKey","usages","deriveBits","public","aesKWAlgorithm","KWalgorithm","kwLength","kwLengthBuffer","kwLengthView","j","eccInfo","ECCCMSSharedInfo","entityUInfo","suppPubInfo","encodedInfo","toBER","ecdhAlgorithm","importKey","wrapKey","fromBER","originator","OriginatorIdentifierOrKey","OriginatorPublicKey","SubKeyTransRecipientInfo","SubKEKRecipientInfo","kekAlgorithm","SubPasswordRecipientinfo","ex","passwordView","iterations","deriveKey","i","all","decrypt","recipientIndex","decryptionParameters","recipientPrivateKey","buffer","unwrapKey","dataBuffer","isConstructed","content"],"mappings":"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","sourcesContent":["import * as asn1js from \"asn1js\";\nimport { getParametersValue, utilConcatBuf, clearProps } from \"pvutils\";\nimport { getOIDByAlgorithm, getRandomValues, getCrypto, getAlgorithmByOID, kdf } from \"./common.js\";\nimport OriginatorInfo from \"./OriginatorInfo.js\";\nimport RecipientInfo from \"./RecipientInfo.js\";\nimport EncryptedContentInfo from \"./EncryptedContentInfo.js\";\nimport Attribute from \"./Attribute.js\";\nimport AlgorithmIdentifier from \"./AlgorithmIdentifier.js\";\nimport RSAESOAEPParams from \"./RSAESOAEPParams.js\";\nimport KeyTransRecipientInfo from \"./KeyTransRecipientInfo.js\";\nimport IssuerAndSerialNumber from \"./IssuerAndSerialNumber.js\";\nimport RecipientEncryptedKey from \"./RecipientEncryptedKey.js\";\nimport KeyAgreeRecipientIdentifier from \"./KeyAgreeRecipientIdentifier.js\";\nimport KeyAgreeRecipientInfo from \"./KeyAgreeRecipientInfo.js\";\nimport RecipientEncryptedKeys from \"./RecipientEncryptedKeys.js\";\nimport KEKRecipientInfo from \"./KEKRecipientInfo.js\";\nimport KEKIdentifier from \"./KEKIdentifier.js\";\nimport PBKDF2Params from \"./PBKDF2Params.js\";\nimport PasswordRecipientinfo from \"./PasswordRecipientinfo.js\";\nimport ECCCMSSharedInfo from \"./ECCCMSSharedInfo.js\";\nimport OriginatorIdentifierOrKey from \"./OriginatorIdentifierOrKey.js\";\nimport OriginatorPublicKey from \"./OriginatorPublicKey.js\";\n//**************************************************************************************\n/**\n * Class from RFC5652\n */\nexport default class EnvelopedData \n{\n\t//**********************************************************************************\n\t/**\n\t * Constructor for EnvelopedData class\n\t * @param {Object} [parameters={}]\n\t * @param {Object} [parameters.schema] asn1js parsed value to initialize the class from\n\t */\n\tconstructor(parameters = {})\n\t{\n\t\t//region Internal properties of the object\n\t\t/**\n\t\t * @type {number}\n\t\t * @desc version\n\t\t */\n\t\tthis.version = getParametersValue(parameters, \"version\", EnvelopedData.defaultValues(\"version\"));\n\t\t\n\t\tif(\"originatorInfo\" in parameters)\n\t\t\t/**\n\t\t\t * @type {OriginatorInfo}\n\t\t\t * @desc originatorInfo\n\t\t\t */\n\t\t\tthis.originatorInfo = getParametersValue(parameters, \"originatorInfo\", EnvelopedData.defaultValues(\"originatorInfo\"));\n\t\t\n\t\t/**\n\t\t * @type {Array.<RecipientInfo>}\n\t\t * @desc recipientInfos\n\t\t */\n\t\tthis.recipientInfos = getParametersValue(parameters, \"recipientInfos\", EnvelopedData.defaultValues(\"recipientInfos\"));\n\t\t/**\n\t\t * @type {EncryptedContentInfo}\n\t\t * @desc encryptedContentInfo\n\t\t */\n\t\tthis.encryptedContentInfo = getParametersValue(parameters, \"encryptedContentInfo\", EnvelopedData.defaultValues(\"encryptedContentInfo\"));\n\t\t\n\t\tif(\"unprotectedAttrs\" in parameters)\n\t\t\t/**\n\t\t\t * @type {Array.<Attribute>}\n\t\t\t * @desc unprotectedAttrs\n\t\t\t */\n\t\t\tthis.unprotectedAttrs = getParametersValue(parameters, \"unprotectedAttrs\", EnvelopedData.defaultValues(\"unprotectedAttrs\"));\n\t\t//endregion\n\t\t\n\t\t//region If input argument array contains \"schema\" for this object\n\t\tif(\"schema\" in parameters)\n\t\t\tthis.fromSchema(parameters.schema);\n\t\t//endregion\n\t}\n\t//**********************************************************************************\n\t/**\n\t * Return default values for all class members\n\t * @param {string} memberName String name for a class member\n\t */\n\tstatic defaultValues(memberName)\n\t{\n\t\tswitch(memberName)\n\t\t{\n\t\t\tcase \"version\":\n\t\t\t\treturn 0;\n\t\t\tcase \"originatorInfo\":\n\t\t\t\treturn new OriginatorInfo();\n\t\t\tcase \"recipientInfos\":\n\t\t\t\treturn [];\n\t\t\tcase \"encryptedContentInfo\":\n\t\t\t\treturn new EncryptedContentInfo();\n\t\t\tcase \"unprotectedAttrs\":\n\t\t\t\treturn [];\n\t\t\tdefault:\n\t\t\t\tthrow new Error(`Invalid member name for EnvelopedData class: ${memberName}`);\n\t\t}\n\t}\n\t//**********************************************************************************\n\t/**\n\t * Compare values with default values for all class members\n\t * @param {string} memberName String name for a class member\n\t * @param {*} memberValue Value to compare with default value\n\t */\n\tstatic compareWithDefault(memberName, memberValue)\n\t{\n\t\tswitch(memberName)\n\t\t{\n\t\t\tcase \"version\":\n\t\t\t\treturn (memberValue === EnvelopedData.defaultValues(memberName));\n\t\t\tcase \"originatorInfo\":\n\t\t\t\treturn ((memberValue.certs.certificates.length === 0) && (memberValue.crls.crls.length === 0));\n\t\t\tcase \"recipientInfos\":\n\t\t\tcase \"unprotectedAttrs\":\n\t\t\t\treturn (memberValue.length === 0);\n\t\t\tcase \"encryptedContentInfo\":\n\t\t\t\treturn ((EncryptedContentInfo.compareWithDefault(\"contentType\", memberValue.contentType)) &&\n\t\t\t\t(EncryptedContentInfo.compareWithDefault(\"contentEncryptionAlgorithm\", memberValue.contentEncryptionAlgorithm) &&\n\t\t\t\t(EncryptedContentInfo.compareWithDefault(\"encryptedContent\", memberValue.encryptedContent))));\n\t\t\tdefault:\n\t\t\t\tthrow new Error(`Invalid member name for EnvelopedData class: ${memberName}`);\n\t\t}\n\t}\n\t//**********************************************************************************\n\t/**\n\t * Return value of pre-defined ASN.1 schema for current class\n\t *\n\t * ASN.1 schema:\n\t * ```asn1\n\t * EnvelopedData ::= SEQUENCE {\n\t *    version CMSVersion,\n\t *    originatorInfo [0] IMPLICIT OriginatorInfo OPTIONAL,\n\t *    recipientInfos RecipientInfos,\n\t *    encryptedContentInfo EncryptedContentInfo,\n\t *    unprotectedAttrs [1] IMPLICIT UnprotectedAttributes OPTIONAL }\n\t * ```\n\t *\n\t * @param {Object} parameters Input parameters for the schema\n\t * @returns {Object} asn1js schema object\n\t */\n\tstatic schema(parameters = {})\n\t{\n\t\t/**\n\t\t * @type {Object}\n\t\t * @property {string} [blockName]\n\t\t * @property {string} [version]\n\t\t * @property {string} [originatorInfo]\n\t\t * @property {string} [recipientInfos]\n\t\t * @property {string} [encryptedContentInfo]\n\t\t * @property {string} [unprotectedAttrs]\n\t\t */\n\t\tconst names = getParametersValue(parameters, \"names\", {});\n\t\t\n\t\treturn (new asn1js.Sequence({\n\t\t\tname: (names.blockName || \"\"),\n\t\t\tvalue: [\n\t\t\t\tnew asn1js.Integer({ name: (names.version || \"\") }),\n\t\t\t\tnew asn1js.Constructed({\n\t\t\t\t\tname: (names.originatorInfo || \"\"),\n\t\t\t\t\toptional: true,\n\t\t\t\t\tidBlock: {\n\t\t\t\t\t\ttagClass: 3, // CONTEXT-SPECIFIC\n\t\t\t\t\t\ttagNumber: 0 // [0]\n\t\t\t\t\t},\n\t\t\t\t\tvalue: OriginatorInfo.schema().valueBlock.value\n\t\t\t\t}),\n\t\t\t\tnew asn1js.Set({\n\t\t\t\t\tvalue: [\n\t\t\t\t\t\tnew asn1js.Repeated({\n\t\t\t\t\t\t\tname: (names.recipientInfos || \"\"),\n\t\t\t\t\t\t\tvalue: RecipientInfo.schema()\n\t\t\t\t\t\t})\n\t\t\t\t\t]\n\t\t\t\t}),\n\t\t\t\tEncryptedContentInfo.schema(names.encryptedContentInfo || {}),\n\t\t\t\tnew asn1js.Constructed({\n\t\t\t\t\toptional: true,\n\t\t\t\t\tidBlock: {\n\t\t\t\t\t\ttagClass: 3, // CONTEXT-SPECIFIC\n\t\t\t\t\t\ttagNumber: 1 // [1]\n\t\t\t\t\t},\n\t\t\t\t\tvalue: [\n\t\t\t\t\t\tnew asn1js.Repeated({\n\t\t\t\t\t\t\tname: (names.unprotectedAttrs || \"\"),\n\t\t\t\t\t\t\tvalue: Attribute.schema()\n\t\t\t\t\t\t})\n\t\t\t\t\t]\n\t\t\t\t})\n\t\t\t]\n\t\t}));\n\t}\n\t//**********************************************************************************\n\t/**\n\t * Convert parsed asn1js object into current class\n\t * @param {!Object} schema\n\t */\n\tfromSchema(schema)\n\t{\n\t\t//region Clear input data first\n\t\tclearProps(schema, [\n\t\t\t\"version\",\n\t\t\t\"originatorInfo\",\n\t\t\t\"recipientInfos\",\n\t\t\t\"encryptedContentInfo\",\n\t\t\t\"unprotectedAttrs\"\n\t\t]);\n\t\t//endregion\n\t\t\n\t\t//region Check the schema is valid\n\t\tconst asn1 = asn1js.compareSchema(schema,\n\t\t\tschema,\n\t\t\tEnvelopedData.schema({\n\t\t\t\tnames: {\n\t\t\t\t\tversion: \"version\",\n\t\t\t\t\toriginatorInfo: \"originatorInfo\",\n\t\t\t\t\trecipientInfos: \"recipientInfos\",\n\t\t\t\t\tencryptedContentInfo: {\n\t\t\t\t\t\tnames: {\n\t\t\t\t\t\t\tblockName: \"encryptedContentInfo\"\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\tunprotectedAttrs: \"unprotectedAttrs\"\n\t\t\t\t}\n\t\t\t})\n\t\t);\n\t\t\n\t\tif(asn1.verified === false)\n\t\t\tthrow new Error(\"Object's schema was not verified against input data for EnvelopedData\");\n\t\t//endregion\n\t\t\n\t\t//region Get internal properties from parsed schema\n\t\tthis.version = asn1.result.version.valueBlock.valueDec;\n\t\t\n\t\tif(\"originatorInfo\" in asn1.result)\n\t\t{\n\t\t\tthis.originatorInfo = new OriginatorInfo({\n\t\t\t\tschema: new asn1js.Sequence({\n\t\t\t\t\tvalue: asn1.result.originatorInfo.valueBlock.value\n\t\t\t\t})\n\t\t\t});\n\t\t}\n\t\t\n\t\tthis.recipientInfos = Array.from(asn1.result.recipientInfos, element => new RecipientInfo({ schema: element }));\n\t\tthis.encryptedContentInfo = new EncryptedContentInfo({ schema: asn1.result.encryptedContentInfo });\n\t\t\n\t\tif(\"unprotectedAttrs\" in asn1.result)\n\t\t\tthis.unprotectedAttrs = Array.from(asn1.result.unprotectedAttrs, element => new Attribute({ schema: element }));\n\t\t//endregion\n\t}\n\t//**********************************************************************************\n\t/**\n\t * Convert current object to asn1js object and set correct values\n\t * @returns {Object} asn1js object\n\t */\n\ttoSchema()\n\t{\n\t\t//region Create array for output sequence\n\t\tconst outputArray = [];\n\t\t\n\t\toutputArray.push(new asn1js.Integer({ value: this.version }));\n\t\t\n\t\tif(\"originatorInfo\" in this)\n\t\t{\n\t\t\toutputArray.push(new asn1js.Constructed({\n\t\t\t\toptional: true,\n\t\t\t\tidBlock: {\n\t\t\t\t\ttagClass: 3, // CONTEXT-SPECIFIC\n\t\t\t\t\ttagNumber: 0 // [0]\n\t\t\t\t},\n\t\t\t\tvalue: this.originatorInfo.toSchema().valueBlock.value\n\t\t\t}));\n\t\t}\n\t\t\n\t\toutputArray.push(new asn1js.Set({\n\t\t\tvalue: Array.from(this.recipientInfos, element => element.toSchema())\n\t\t}));\n\t\t\n\t\toutputArray.push(this.encryptedContentInfo.toSchema());\n\t\t\n\t\tif(\"unprotectedAttrs\" in this)\n\t\t{\n\t\t\toutputArray.push(new asn1js.Constructed({\n\t\t\t\toptional: true,\n\t\t\t\tidBlock: {\n\t\t\t\t\ttagClass: 3, // CONTEXT-SPECIFIC\n\t\t\t\t\ttagNumber: 1 // [1]\n\t\t\t\t},\n\t\t\t\tvalue: Array.from(this.unprotectedAttrs, element => element.toSchema())\n\t\t\t}));\n\t\t}\n\t\t//endregion\n\t\t\n\t\t//region Construct and return new ASN.1 schema for this object\n\t\treturn (new asn1js.Sequence({\n\t\t\tvalue: outputArray\n\t\t}));\n\t\t//endregion\n\t}\n\t//**********************************************************************************\n\t/**\n\t * Convertion for the class to JSON object\n\t * @returns {Object}\n\t */\n\ttoJSON()\n\t{\n\t\tconst _object = {\n\t\t\tversion: this.version\n\t\t};\n\t\t\n\t\tif(\"originatorInfo\" in this)\n\t\t\t_object.originatorInfo = this.originatorInfo.toJSON();\n\t\t\n\t\t_object.recipientInfos = Array.from(this.recipientInfos, element => element.toJSON());\n\t\t_object.encryptedContentInfo = this.encryptedContentInfo.toJSON();\n\t\t\n\t\tif(\"unprotectedAttrs\" in this)\n\t\t\t_object.unprotectedAttrs = Array.from(this.unprotectedAttrs, element => element.toJSON());\n\t\t\n\t\treturn _object;\n\t}\n\t//**********************************************************************************\n\t/**\n\t * Helpers function for filling \"RecipientInfo\" based on recipient's certificate.\n\t * Problem with WebCrypto is that for RSA certificates we have only one option - \"key transport\" and\n\t * for ECC certificates we also have one option - \"key agreement\". As soon as Google will implement\n\t * DH algorithm it would be possible to use \"key agreement\" also for RSA certificates.\n\t * @param {Certificate} [certificate] Recipient's certificate\n\t * @param {Object} [parameters] Additional parameters neccessary for \"fine tunning\" of encryption process\n\t * @param {number} [variant] Variant = 1 is for \"key transport\", variant = 2 is for \"key agreement\". In fact the \"variant\" is unneccessary now because Google has no DH algorithm implementation. Thus key encryption scheme would be choosen by certificate type only: \"key transport\" for RSA and \"key agreement\" for ECC certificates.\n\t */\n\taddRecipientByCertificate(certificate, parameters, variant)\n\t{\n\t\t//region Initial variables \n\t\tconst encryptionParameters = parameters || {};\n\t\t//endregion \n\t\t\n\t\t//region Check type of certificate\n\t\tif(certificate.subjectPublicKeyInfo.algorithm.algorithmId.indexOf(\"1.2.840.113549\") !== (-1))\n\t\t\tvariant = 1; // For the moment it is the only variant for RSA-based certificates\n\t\telse\n\t\t{\n\t\t\tif(certificate.subjectPublicKeyInfo.algorithm.algorithmId.indexOf(\"1.2.840.10045\") !== (-1))\n\t\t\t\tvariant = 2; // For the moment it is the only variant for ECC-based certificates\n\t\t\telse\n\t\t\t\tthrow new Error(`Unknown type of certificate's public key: ${certificate.subjectPublicKeyInfo.algorithm.algorithmId}`);\n\t\t}\n\t\t//endregion \n\t\t\n\t\t//region Initialize encryption parameters \n\t\tif((\"oaepHashAlgorithm\" in encryptionParameters) === false)\n\t\t\tencryptionParameters.oaepHashAlgorithm = \"SHA-512\";\n\t\t\n\t\tif((\"kdfAlgorithm\" in encryptionParameters) === false)\n\t\t\tencryptionParameters.kdfAlgorithm = \"SHA-512\";\n\t\t\n\t\tif((\"kekEncryptionLength\" in encryptionParameters) === false)\n\t\t\tencryptionParameters.kekEncryptionLength = 256;\n\t\t//endregion \n\t\t\n\t\t//region Add new \"recipient\" depends on \"variant\" and certificate type \n\t\tswitch(variant)\n\t\t{\n\t\t\tcase 1: // Key transport scheme\n\t\t\t\t{\n\t\t\t\t\t//region keyEncryptionAlgorithm\n\t\t\t\t\tconst oaepOID = getOIDByAlgorithm({\n\t\t\t\t\t\tname: \"RSA-OAEP\"\n\t\t\t\t\t});\n\t\t\t\t\tif(oaepOID === \"\")\n\t\t\t\t\t\tthrow new Error(\"Can not find OID for OAEP\");\n\t\t\t\t\t//endregion\n\n\t\t\t\t\t//region RSAES-OAEP-params\n\t\t\t\t\tconst hashOID = getOIDByAlgorithm({\n\t\t\t\t\t\tname: encryptionParameters.oaepHashAlgorithm\n\t\t\t\t\t});\n\t\t\t\t\tif(hashOID === \"\")\n\t\t\t\t\t\tthrow new Error(`Unknown OAEP hash algorithm: ${encryptionParameters.oaepHashAlgorithm}`);\n\t\t\t\t\n\t\t\t\t\tconst hashAlgorithm = new AlgorithmIdentifier({\n\t\t\t\t\t\talgorithmId: hashOID,\n\t\t\t\t\t\talgorithmParams: new asn1js.Null()\n\t\t\t\t\t});\n\t\t\t\t\n\t\t\t\t\tconst rsaOAEPParams = new RSAESOAEPParams({\n\t\t\t\t\t\thashAlgorithm,\n\t\t\t\t\t\tmaskGenAlgorithm: new AlgorithmIdentifier({\n\t\t\t\t\t\t\talgorithmId: \"1.2.840.113549.1.1.8\", // id-mgf1\n\t\t\t\t\t\t\talgorithmParams: hashAlgorithm.toSchema()\n\t\t\t\t\t\t})\n\t\t\t\t\t});\n\t\t\t\t\t//endregion\n\n\t\t\t\t\t//region KeyTransRecipientInfo\n\t\t\t\t\tconst keyInfo = new KeyTransRecipientInfo({\n\t\t\t\t\t\tversion: 0,\n\t\t\t\t\t\trid: new IssuerAndSerialNumber({\n\t\t\t\t\t\t\tissuer: certificate.issuer,\n\t\t\t\t\t\t\tserialNumber: certificate.serialNumber\n\t\t\t\t\t\t}),\n\t\t\t\t\t\tkeyEncryptionAlgorithm: new AlgorithmIdentifier({\n\t\t\t\t\t\t\talgorithmId: oaepOID,\n\t\t\t\t\t\t\talgorithmParams: rsaOAEPParams.toSchema()\n\t\t\t\t\t\t}),\n\t\t\t\t\t\trecipientCertificate: certificate\n\t\t\t\t\t\t// \"encryptedKey\" will be calculated in \"encrypt\" function\n\t\t\t\t\t});\n\t\t\t\t\t//endregion\n\t\t\t\t\n\t\t\t\t\t//region Final values for \"CMS_ENVELOPED_DATA\"\n\t\t\t\t\tthis.recipientInfos.push(new RecipientInfo({\n\t\t\t\t\t\tvariant: 1,\n\t\t\t\t\t\tvalue: keyInfo\n\t\t\t\t\t}));\n\t\t\t\t\t//endregion\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 2: // Key agreement scheme\n\t\t\t\t{\n\t\t\t\t\t//region RecipientEncryptedKey\n\t\t\t\t\tconst encryptedKey = new RecipientEncryptedKey({\n\t\t\t\t\t\trid: new KeyAgreeRecipientIdentifier({\n\t\t\t\t\t\t\tvariant: 1,\n\t\t\t\t\t\t\tvalue: new IssuerAndSerialNumber({\n\t\t\t\t\t\t\t\tissuer: certificate.issuer,\n\t\t\t\t\t\t\t\tserialNumber: certificate.serialNumber\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t})\n\t\t\t\t\t// \"encryptedKey\" will be calculated in \"encrypt\" function\n\t\t\t\t\t});\n\t\t\t\t\t//endregion\n\t\t\t\t\n\t\t\t\t\t//region keyEncryptionAlgorithm\n\t\t\t\t\tconst aesKWoid = getOIDByAlgorithm({\n\t\t\t\t\t\tname: \"AES-KW\",\n\t\t\t\t\t\tlength: encryptionParameters.kekEncryptionLength\n\t\t\t\t\t});\n\t\t\t\t\tif(aesKWoid === \"\")\n\t\t\t\t\t\tthrow new Error(`Unknown length for key encryption algorithm: ${encryptionParameters.kekEncryptionLength}`);\n\t\t\t\t\n\t\t\t\t\tconst aesKW = new AlgorithmIdentifier({\n\t\t\t\t\t\talgorithmId: aesKWoid,\n\t\t\t\t\t\talgorithmParams: new asn1js.Null()\n\t\t\t\t\t});\n\t\t\t\t\t//endregion\n\n\t\t\t\t\t//region KeyAgreeRecipientInfo\n\t\t\t\t\tconst ecdhOID = getOIDByAlgorithm({\n\t\t\t\t\t\tname: \"ECDH\",\n\t\t\t\t\t\tkdf: encryptionParameters.kdfAlgorithm\n\t\t\t\t\t});\n\t\t\t\t\tif(ecdhOID === \"\")\n\t\t\t\t\t\tthrow new Error(`Unknown KDF algorithm: ${encryptionParameters.kdfAlgorithm}`);\n\t\t\t\t\n\t\t\t\t\t// In fact there is no need in so long UKM, but RFC2631\n\t\t\t\t\t// has requirement that \"UserKeyMaterial\" must be 512 bits long\n\t\t\t\t\tconst ukmBuffer = new ArrayBuffer(64);\n\t\t\t\t\tconst ukmView = new Uint8Array(ukmBuffer);\n\t\t\t\t\tgetRandomValues(ukmView); // Generate random values in 64 bytes long buffer\n\t\t\t\t\n\t\t\t\t\tconst keyInfo = new KeyAgreeRecipientInfo({\n\t\t\t\t\t\tversion: 3,\n\t\t\t\t\t\t// \"originator\" will be calculated in \"encrypt\" function because ephemeral key would be generated there\n\t\t\t\t\t\tukm: new asn1js.OctetString({ valueHex: ukmBuffer }),\n\t\t\t\t\t\tkeyEncryptionAlgorithm: new AlgorithmIdentifier({\n\t\t\t\t\t\t\talgorithmId: ecdhOID,\n\t\t\t\t\t\t\talgorithmParams: aesKW.toSchema()\n\t\t\t\t\t\t}),\n\t\t\t\t\t\trecipientEncryptedKeys: new RecipientEncryptedKeys({\n\t\t\t\t\t\t\tencryptedKeys: [encryptedKey]\n\t\t\t\t\t\t}),\n\t\t\t\t\t\trecipientCertificate: certificate\n\t\t\t\t\t});\n\t\t\t\t\t//endregion\n\n\t\t\t\t\t//region Final values for \"CMS_ENVELOPED_DATA\"\n\t\t\t\t\tthis.recipientInfos.push(new RecipientInfo({\n\t\t\t\t\t\tvariant: 2,\n\t\t\t\t\t\tvalue: keyInfo\n\t\t\t\t\t}));\n\t\t\t\t\t//endregion\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tthrow new Error(`Unknown \"variant\" value: ${variant}`);\n\t\t}\n\t\t//endregion \n\t\t\n\t\treturn true;\n\t}\n\t//**********************************************************************************\n\t/**\n\t * Add recipient based on pre-defined data like password or KEK\n\t * @param {ArrayBuffer} preDefinedData ArrayBuffer with pre-defined data\n\t * @param {Object} parameters Additional parameters neccessary for \"fine tunning\" of encryption process\n\t * @param {number} variant Variant = 1 for pre-defined \"key encryption key\" (KEK). Variant = 2 for password-based encryption.\n\t */\n\taddRecipientByPreDefinedData(preDefinedData, parameters, variant)\n\t{\n\t\t//region Initial variables\n\t\tconst encryptionParameters = parameters || {};\n\t\t//endregion\n\t\t\n\t\t//region Check initial parameters\n\t\tif((preDefinedData instanceof ArrayBuffer) === false)\n\t\t\tthrow new Error(\"Please pass \\\"preDefinedData\\\" in ArrayBuffer type\");\n\t\t\n\t\tif(preDefinedData.byteLength === 0)\n\t\t\tthrow new Error(\"Pre-defined data could have zero length\");\n\t\t//endregion\n\t\t\n\t\t//region Initialize encryption parameters\n\t\tif((\"keyIdentifier\" in encryptionParameters) === false)\n\t\t{\n\t\t\tconst keyIdentifierBuffer = new ArrayBuffer(16);\n\t\t\tconst keyIdentifierView = new Uint8Array(keyIdentifierBuffer);\n\t\t\tgetRandomValues(keyIdentifierView);\n\t\t\t\n\t\t\tencryptionParameters.keyIdentifier = keyIdentifierBuffer;\n\t\t}\n\t\t\n\t\tif((\"hmacHashAlgorithm\" in encryptionParameters) === false)\n\t\t\tencryptionParameters.hmacHashAlgorithm = \"SHA-512\";\n\t\t\n\t\tif((\"iterationCount\" in encryptionParameters) === false)\n\t\t\tencryptionParameters.iterationCount = 2048;\n\t\t\n\t\tif((\"keyEncryptionAlgorithm\" in encryptionParameters) === false)\n\t\t{\n\t\t\tencryptionParameters.keyEncryptionAlgorithm = {\n\t\t\t\tname: \"AES-KW\",\n\t\t\t\tlength: 256\n\t\t\t};\n\t\t}\n\t\t\n\t\tif((\"keyEncryptionAlgorithmParams\" in encryptionParameters) === false)\n\t\t\tencryptionParameters.keyEncryptionAlgorithmParams = new asn1js.Null();\n\t\t//endregion\n\t\t\n\t\t//region Add new recipient based on passed variant\n\t\tswitch(variant)\n\t\t{\n\t\t\tcase 1: // KEKRecipientInfo\n\t\t\t\t{\n\t\t\t\t\t//region keyEncryptionAlgorithm\n\t\t\t\t\tconst kekOID = getOIDByAlgorithm(encryptionParameters.keyEncryptionAlgorithm);\n\t\t\t\t\tif(kekOID === \"\")\n\t\t\t\t\t\tthrow new Error(\"Incorrect value for \\\"keyEncryptionAlgorithm\\\"\");\n\t\t\t\t\t//endregion\n\n\t\t\t\t\t//region KEKRecipientInfo\n\t\t\t\t\tconst keyInfo = new KEKRecipientInfo({\n\t\t\t\t\t\tversion: 4,\n\t\t\t\t\t\tkekid: new KEKIdentifier({\n\t\t\t\t\t\t\tkeyIdentifier: new asn1js.OctetString({ valueHex: encryptionParameters.keyIdentifier })\n\t\t\t\t\t\t}),\n\t\t\t\t\t\tkeyEncryptionAlgorithm: new AlgorithmIdentifier({\n\t\t\t\t\t\t\talgorithmId: kekOID,\n\t\t\t\t\t\t\t/*\n\t\t\t\t\t\t\t For AES-KW params are NULL, but for other algorithm could another situation.\n\t\t\t\t\t\t\t */\n\t\t\t\t\t\t\talgorithmParams: encryptionParameters.keyEncryptionAlgorithmParams\n\t\t\t\t\t\t}),\n\t\t\t\t\t\tpreDefinedKEK: preDefinedData\n\t\t\t\t\t// \"encryptedKey\" would be set in \"ecrypt\" function\n\t\t\t\t\t});\n\t\t\t\t\t//endregion\n\n\t\t\t\t\t//region Final values for \"CMS_ENVELOPED_DATA\"\n\t\t\t\t\tthis.recipientInfos.push(new RecipientInfo({\n\t\t\t\t\t\tvariant: 3,\n\t\t\t\t\t\tvalue: keyInfo\n\t\t\t\t\t}));\n\t\t\t\t\t//endregion\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 2: // PasswordRecipientinfo\n\t\t\t\t{\n\t\t\t\t\t//region keyDerivationAlgorithm\n\t\t\t\t\tconst pbkdf2OID = getOIDByAlgorithm({\n\t\t\t\t\t\tname: \"PBKDF2\"\n\t\t\t\t\t});\n\t\t\t\t\tif(pbkdf2OID === \"\")\n\t\t\t\t\t\tthrow new Error(\"Can not find OID for PBKDF2\");\n\t\t\t\t\t//endregion\n\n\t\t\t\t\t//region Salt\n\t\t\t\t\tconst saltBuffer = new ArrayBuffer(64);\n\t\t\t\t\tconst saltView = new Uint8Array(saltBuffer);\n\t\t\t\t\tgetRandomValues(saltView);\n\t\t\t\t\t//endregion\n\n\t\t\t\t\t//region HMAC-based algorithm\n\t\t\t\t\tconst hmacOID = getOIDByAlgorithm({\n\t\t\t\t\t\tname: \"HMAC\",\n\t\t\t\t\t\thash: {\n\t\t\t\t\t\t\tname: encryptionParameters.hmacHashAlgorithm\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t\tif(hmacOID === \"\")\n\t\t\t\t\t\tthrow new Error(`Incorrect value for \"hmacHashAlgorithm\": ${encryptionParameters.hmacHashAlgorithm}`);\n\t\t\t\t\t//endregion\n\n\t\t\t\t\t//region PBKDF2-params\n\t\t\t\t\tconst pbkdf2Params = new PBKDF2Params({\n\t\t\t\t\t\tsalt: new asn1js.OctetString({ valueHex: saltBuffer }),\n\t\t\t\t\t\titerationCount: encryptionParameters.iterationCount,\n\t\t\t\t\t\tprf: new AlgorithmIdentifier({\n\t\t\t\t\t\t\talgorithmId: hmacOID,\n\t\t\t\t\t\t\talgorithmParams: new asn1js.Null()\n\t\t\t\t\t\t})\n\t\t\t\t\t});\n\t\t\t\t\t//endregion\n\n\t\t\t\t\t//region keyEncryptionAlgorithm\n\t\t\t\t\tconst kekOID = getOIDByAlgorithm(encryptionParameters.keyEncryptionAlgorithm);\n\t\t\t\t\tif(kekOID === \"\")\n\t\t\t\t\t\tthrow new Error(\"Incorrect value for \\\"keyEncryptionAlgorithm\\\"\");\n\t\t\t\t\t//endregion\n\n\t\t\t\t\t//region PasswordRecipientinfo\n\t\t\t\t\tconst keyInfo = new PasswordRecipientinfo({\n\t\t\t\t\t\tversion: 0,\n\t\t\t\t\t\tkeyDerivationAlgorithm: new AlgorithmIdentifier({\n\t\t\t\t\t\t\talgorithmId: pbkdf2OID,\n\t\t\t\t\t\t\talgorithmParams: pbkdf2Params.toSchema()\n\t\t\t\t\t\t}),\n\t\t\t\t\t\tkeyEncryptionAlgorithm: new AlgorithmIdentifier({\n\t\t\t\t\t\t\talgorithmId: kekOID,\n\t\t\t\t\t\t\t/*\n\t\t\t\t\t\t\t For AES-KW params are NULL, but for other algorithm could be another situation.\n\t\t\t\t\t\t\t */\n\t\t\t\t\t\t\talgorithmParams: encryptionParameters.keyEncryptionAlgorithmParams\n\t\t\t\t\t\t}),\n\t\t\t\t\t\tpassword: preDefinedData\n\t\t\t\t\t// \"encryptedKey\" would be set in \"ecrypt\" function\n\t\t\t\t\t});\n\t\t\t\t\t//endregion\n\n\t\t\t\t\t//region Final values for \"CMS_ENVELOPED_DATA\"\n\t\t\t\t\tthis.recipientInfos.push(new RecipientInfo({\n\t\t\t\t\t\tvariant: 4,\n\t\t\t\t\t\tvalue: keyInfo\n\t\t\t\t\t}));\n\t\t\t\t\t//endregion\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tthrow new Error(`Unknown value for \"variant\": ${variant}`);\n\t\t}\n\t\t//endregion\n\t}\n\t//**********************************************************************************\n\t/**\n\t * Create a new CMS Enveloped Data content with encrypted data\n\t * @param {Object} contentEncryptionAlgorithm WebCrypto algorithm. For the moment here could be only \"AES-CBC\" or \"AES-GCM\" algorithms.\n\t * @param {ArrayBuffer} contentToEncrypt Content to encrypt\n\t * @returns {Promise}\n\t */\n\tencrypt(contentEncryptionAlgorithm, contentToEncrypt)\n\t{\n\t\t//region Initial variables\n\t\tlet sequence = Promise.resolve();\n\t\t\n\t\tconst ivBuffer = new ArrayBuffer(16); // For AES we need IV 16 bytes long\n\t\tconst ivView = new Uint8Array(ivBuffer);\n\t\tgetRandomValues(ivView);\n\t\t\n\t\tconst contentView = new Uint8Array(contentToEncrypt);\n\t\t\n\t\tlet sessionKey;\n\t\tlet encryptedContent;\n\t\tlet exportedSessionKey;\n\t\t\n\t\tconst recipientsPromises = [];\n\t\t\n\t\tconst _this = this;\n\t\t//endregion\n\t\t\n\t\t//region Check for input parameters\n\t\tconst contentEncryptionOID = getOIDByAlgorithm(contentEncryptionAlgorithm);\n\t\tif(contentEncryptionOID === \"\")\n\t\t\treturn Promise.reject(\"Wrong \\\"contentEncryptionAlgorithm\\\" value\");\n\t\t//endregion\n\t\t\n\t\t//region Get a \"crypto\" extension\n\t\tconst crypto = getCrypto();\n\t\tif(typeof crypto === \"undefined\")\n\t\t\treturn Promise.reject(\"Unable to create WebCrypto object\");\n\t\t//endregion\n\t\t\n\t\t//region Generate new content encryption key\n\t\tsequence = sequence.then(() =>\n\t\t\tcrypto.generateKey(contentEncryptionAlgorithm, true, [\"encrypt\"]));\n\t\t//endregion\n\t\t//region Encrypt content\n\t\tsequence = sequence.then(result =>\n\t\t{\n\t\t\tsessionKey = result;\n\t\t\t\n\t\t\treturn crypto.encrypt({\n\t\t\t\tname: contentEncryptionAlgorithm.name,\n\t\t\t\tiv: ivView\n\t\t\t},\n\t\t\tsessionKey,\n\t\t\tcontentView);\n\t\t}, error =>\n\t\t\tPromise.reject(error));\n\t\t//endregion\n\t\t//region Export raw content of content encryption key\n\t\tsequence = sequence.then(result =>\n\t\t{\n\t\t\t//region Create output OCTETSTRING with encrypted content\n\t\t\tencryptedContent = result;\n\t\t\t//endregion\n\t\t\t\t\n\t\t\treturn crypto.exportKey(\"raw\", sessionKey);\n\t\t}, error =>\n\t\t\tPromise.reject(error)\n\t\t).then(result =>\n\t\t{\n\t\t\texportedSessionKey = result;\n\t\t\t\n\t\t\treturn true;\n\t\t}, error =>\n\t\t\tPromise.reject(error));\n\t\t//endregion\n\t\t//region Append common information to CMS_ENVELOPED_DATA\n\t\tsequence = sequence.then(() =>\n\t\t{\n\t\t\tthis.version = 2;\n\t\t\tthis.encryptedContentInfo = new EncryptedContentInfo({\n\t\t\t\tcontentType: \"1.2.840.113549.1.7.1\", // \"data\"\n\t\t\t\tcontentEncryptionAlgorithm: new AlgorithmIdentifier({\n\t\t\t\t\talgorithmId: contentEncryptionOID,\n\t\t\t\t\talgorithmParams: new asn1js.OctetString({ valueHex: ivBuffer })\n\t\t\t\t}),\n\t\t\t\tencryptedContent: new asn1js.OctetString({ valueHex: encryptedContent })\n\t\t\t});\n\t\t}, error =>\n\t\t\tPromise.reject(error));\n\t\t//endregion\n\t\t\n\t\t//region Special sub-functions to work with each recipient's type\n\t\tfunction SubKeyAgreeRecipientInfo(index)\n\t\t{\n\t\t\t//region Initial variables\n\t\t\tlet currentSequence = Promise.resolve();\n\t\t\t\n\t\t\tlet ecdhPublicKey;\n\t\t\tlet ecdhPrivateKey;\n\t\t\t\n\t\t\tlet recipientCurve;\n\t\t\tlet recipientCurveLength;\n\t\t\t\n\t\t\tlet exportedECDHPublicKey;\n\t\t\t//endregion\n\t\t\t\n\t\t\t//region Get \"namedCurve\" parameter from recipient's certificate\n\t\t\tcurrentSequence = currentSequence.then(() =>\n\t\t\t{\n\t\t\t\tconst curveObject = _this.recipientInfos[index].value.recipientCertificate.subjectPublicKeyInfo.algorithm.algorithmParams;\n\t\t\t\t\n\t\t\t\tif(curveObject.constructor.blockName() !== asn1js.ObjectIdentifier.blockName())\n\t\t\t\t\treturn Promise.reject(`Incorrect \"recipientCertificate\" for index ${index}`);\n\t\t\t\t\n\t\t\t\tconst curveOID = curveObject.valueBlock.toString();\n\t\t\t\t\n\t\t\t\tswitch(curveOID)\n\t\t\t\t{\n\t\t\t\t\tcase \"1.2.840.10045.3.1.7\":\n\t\t\t\t\t\trecipientCurve = \"P-256\";\n\t\t\t\t\t\trecipientCurveLength = 256;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase \"1.3.132.0.34\":\n\t\t\t\t\t\trecipientCurve = \"P-384\";\n\t\t\t\t\t\trecipientCurveLength = 384;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase \"1.3.132.0.35\":\n\t\t\t\t\t\trecipientCurve = \"P-521\";\n\t\t\t\t\t\trecipientCurveLength = 528;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tdefault:\n\t\t\t\t\t\treturn Promise.reject(`Incorrect curve OID for index ${index}`);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\treturn recipientCurve;\n\t\t\t}, error =>\n\t\t\t\tPromise.reject(error));\n\t\t\t//endregion\n\t\t\t\n\t\t\t//region Generate ephemeral ECDH key\n\t\t\tcurrentSequence = currentSequence.then(result =>\n\t\t\t\tcrypto.generateKey({\n\t\t\t\t\tname: \"ECDH\",\n\t\t\t\t\tnamedCurve: result\n\t\t\t\t},\n\t\t\t\ttrue,\n\t\t\t\t[\"deriveBits\"]),\n\t\t\terror =>\n\t\t\t\tPromise.reject(error)\n\t\t\t);\n\t\t\t//endregion\n\t\t\t//region Export public key of ephemeral ECDH key pair\n\t\t\tcurrentSequence = currentSequence.then(result =>\n\t\t\t{\n\t\t\t\tecdhPublicKey = result.publicKey;\n\t\t\t\tecdhPrivateKey = result.privateKey;\n\t\t\t\t\t\n\t\t\t\treturn crypto.exportKey(\"spki\", ecdhPublicKey);\n\t\t\t},\n\t\t\terror =>\n\t\t\t\tPromise.reject(error));\n\t\t\t//endregion\n\t\t\t\n\t\t\t//region Import recipient's public key\n\t\t\tcurrentSequence = currentSequence.then(result =>\n\t\t\t{\n\t\t\t\texportedECDHPublicKey = result;\n\t\t\t\t\n\t\t\t\treturn _this.recipientInfos[index].value.recipientCertificate.getPublicKey({\n\t\t\t\t\talgorithm: {\n\t\t\t\t\t\talgorithm: {\n\t\t\t\t\t\t\tname: \"ECDH\",\n\t\t\t\t\t\t\tnamedCurve: recipientCurve\n\t\t\t\t\t\t},\n\t\t\t\t\t\tusages: []\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}, error =>\n\t\t\t\tPromise.reject(error));\n\t\t\t//endregion\n\t\t\t//region Create shared secret\n\t\t\tcurrentSequence = currentSequence.then(result => crypto.deriveBits({\n\t\t\t\tname: \"ECDH\",\n\t\t\t\tpublic: result\n\t\t\t},\n\t\t\tecdhPrivateKey,\n\t\t\trecipientCurveLength),\n\t\t\terror =>\n\t\t\t\tPromise.reject(error));\n\t\t\t//endregion\n\t\t\t\n\t\t\t//region Apply KDF function to shared secret\n\t\t\tcurrentSequence = currentSequence.then(\n\t\t\t\t/**\n\t\t\t\t * @param {ArrayBuffer} result\n\t\t\t\t */\n\t\t\t\tresult =>\n\t\t\t\t{\n\t\t\t\t\t//region Get length of used AES-KW algorithm\n\t\t\t\t\tconst aesKWAlgorithm = new AlgorithmIdentifier({ schema: _this.recipientInfos[index].value.keyEncryptionAlgorithm.algorithmParams });\n\t\t\t\t\t\n\t\t\t\t\tconst KWalgorithm = getAlgorithmByOID(aesKWAlgorithm.algorithmId);\n\t\t\t\t\tif((\"name\" in KWalgorithm) === false)\n\t\t\t\t\t\treturn Promise.reject(`Incorrect OID for key encryption algorithm: ${aesKWAlgorithm.algorithmId}`);\n\t\t\t\t\t//endregion\n\t\t\t\t\t\n\t\t\t\t\t//region Translate AES-KW length to ArrayBuffer\n\t\t\t\t\tlet kwLength = KWalgorithm.length;\n\t\t\t\t\t\n\t\t\t\t\tconst kwLengthBuffer = new ArrayBuffer(4);\n\t\t\t\t\tconst kwLengthView = new Uint8Array(kwLengthBuffer);\n\t\t\t\t\t\n\t\t\t\t\tfor(let j = 3; j >= 0; j--)\n\t\t\t\t\t{\n\t\t\t\t\t\tkwLengthView[j] = kwLength;\n\t\t\t\t\t\tkwLength >>= 8;\n\t\t\t\t\t}\n\t\t\t\t\t//endregion\n\t\t\t\t\t\n\t\t\t\t\t//region Create and encode \"ECC-CMS-SharedInfo\" structure\n\t\t\t\t\tconst eccInfo = new ECCCMSSharedInfo({\n\t\t\t\t\t\tkeyInfo: new AlgorithmIdentifier({\n\t\t\t\t\t\t\talgorithmId: aesKWAlgorithm.algorithmId,\n\t\t\t\t\t\t\t/*\n\t\t\t\t\t\t\t Initially RFC5753 says that AES algorithms have absent parameters.\n\t\t\t\t\t\t\t But since early implementations all put NULL here. Thus, in order to be\n\t\t\t\t\t\t\t \"backward compatible\", index also put NULL here.\n\t\t\t\t\t\t\t */\n\t\t\t\t\t\t\talgorithmParams: new asn1js.Null()\n\t\t\t\t\t\t}),\n\t\t\t\t\t\tentityUInfo: _this.recipientInfos[index].value.ukm,\n\t\t\t\t\t\tsuppPubInfo: new asn1js.OctetString({ valueHex: kwLengthBuffer })\n\t\t\t\t\t});\n\t\t\t\t\t\n\t\t\t\t\tconst encodedInfo = eccInfo.toSchema().toBER(false);\n\t\t\t\t\t//endregion\n\t\t\t\t\t\n\t\t\t\t\t//region Get SHA algorithm used together with ECDH\n\t\t\t\t\tconst ecdhAlgorithm = getAlgorithmByOID(_this.recipientInfos[index].value.keyEncryptionAlgorithm.algorithmId);\n\t\t\t\t\tif((\"name\" in ecdhAlgorithm) === false)\n\t\t\t\t\t\treturn Promise.reject(`Incorrect OID for key encryption algorithm: ${_this.recipientInfos[index].value.keyEncryptionAlgorithm.algorithmId}`);\n\t\t\t\t\t//endregion\n\t\t\t\t\t\n\t\t\t\t\treturn kdf(ecdhAlgorithm.kdf, result, KWalgorithm.length, encodedInfo);\n\t\t\t\t},\n\t\t\t\terror =>\n\t\t\t\t\tPromise.reject(error));\n\t\t\t//endregion\n\t\t\t//region Import AES-KW key from result of KDF function\n\t\t\tcurrentSequence = currentSequence.then(result =>\n\t\t\t\tcrypto.importKey(\"raw\", result, { name: \"AES-KW\" }, true, [\"wrapKey\"]),\n\t\t\terror =>\n\t\t\t\tPromise.reject(error)\n\t\t\t);\n\t\t\t//endregion\n\t\t\t//region Finally wrap session key by using AES-KW algorithm\n\t\t\tcurrentSequence = currentSequence.then(result => crypto.wrapKey(\"raw\", sessionKey, result, { name: \"AES-KW\" }),\n\t\t\t\terror =>\n\t\t\t\t\tPromise.reject(error)\n\t\t\t);\n\t\t\t//endregion\n\t\t\t//region Append all neccessary data to current CMS_RECIPIENT_INFO object\n\t\t\tcurrentSequence = currentSequence.then(result =>\n\t\t\t{\n\t\t\t\t//region OriginatorIdentifierOrKey\n\t\t\t\tconst asn1 = asn1js.fromBER(exportedECDHPublicKey);\n\t\t\t\t\t\n\t\t\t\tconst originator = new OriginatorIdentifierOrKey();\n\t\t\t\toriginator.variant = 3;\n\t\t\t\toriginator.value = new OriginatorPublicKey({ schema: asn1.result });\n\t\t\t\t// There is option when we can stay with ECParameters, but here index prefer to avoid the params\n\t\t\t\tif(\"algorithmParams\" in originator.value.algorithm)\n\t\t\t\t\tdelete originator.value.algorithm.algorithmParams;\n\t\t\t\t\t\n\t\t\t\t_this.recipientInfos[index].value.originator = originator;\n\t\t\t\t//endregion\n\t\t\t\t\t\n\t\t\t\t//region RecipientEncryptedKey\n\t\t\t\t/*\n\t\t\t\t We will not support using of same ephemeral key for many recipients\n\t\t\t\t */\n\t\t\t\t_this.recipientInfos[index].value.recipientEncryptedKeys.encryptedKeys[0].encryptedKey = new asn1js.OctetString({ valueHex: result });\n\t\t\t\t//endregion\n\n\t\t\t\treturn {ecdhPrivateKey};\n\t\t\t}, error =>\n\t\t\t\tPromise.reject(error)\n\t\t\t);\n\t\t\t//endregion\n\t\t\t\n\t\t\treturn currentSequence;\n\t\t}\n\t\t\n\t\tfunction SubKeyTransRecipientInfo(index)\n\t\t{\n\t\t\t//region Initial variables\n\t\t\tlet currentSequence = Promise.resolve();\n\t\t\t//endregion\n\t\t\t\n\t\t\t//region Get recipient's public key\n\t\t\tcurrentSequence = currentSequence.then(() =>\n\t\t\t{\n\t\t\t\t//region Check we have a correct algorithm here\n\t\t\t\tconst oaepOID = getOIDByAlgorithm({\n\t\t\t\t\tname: \"RSA-OAEP\"\n\t\t\t\t});\n\t\t\t\tif(oaepOID === \"\")\n\t\t\t\t\tthrow new Error(\"Can not find OID for OAEP\");\n\n\t\t\t\tif(_this.recipientInfos[index].value.keyEncryptionAlgorithm.algorithmId !== oaepOID)\n\t\t\t\t\tthrow new Error(\"Not supported encryption scheme, only RSA-OAEP is supported for key transport encryption scheme\");\n\t\t\t\t//endregion\n\n\t\t\t\t//region Get current used SHA algorithm\n\t\t\t\tconst schema = _this.recipientInfos[index].value.keyEncryptionAlgorithm.algorithmParams;\n\t\t\t\tconst rsaOAEPParams = new RSAESOAEPParams({ schema });\n\t\t\t\t\n\t\t\t\tconst hashAlgorithm = getAlgorithmByOID(rsaOAEPParams.hashAlgorithm.algorithmId);\n\t\t\t\tif((\"name\" in hashAlgorithm) === false)\n\t\t\t\t\treturn Promise.reject(`Incorrect OID for hash algorithm: ${rsaOAEPParams.hashAlgorithm.algorithmId}`);\n\t\t\t\t//endregion\n\t\t\t\t\n\t\t\t\treturn _this.recipientInfos[index].value.recipientCertificate.getPublicKey({\n\t\t\t\t\talgorithm: {\n\t\t\t\t\t\talgorithm: {\n\t\t\t\t\t\t\tname: \"RSA-OAEP\",\n\t\t\t\t\t\t\thash: {\n\t\t\t\t\t\t\t\tname: hashAlgorithm.name\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\n\t\t\t\t\t\tusages: [\"encrypt\", \"wrapKey\"]\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}, error =>\n\t\t\t\tPromise.reject(error));\n\t\t\t//endregion\n\t\t\t//region Encrypt early exported session key on recipient's public key\n\t\t\tcurrentSequence = currentSequence.then(result =>\n\t\t\t\tcrypto.encrypt(result.algorithm, result, exportedSessionKey),\n\t\t\terror =>\n\t\t\t\tPromise.reject(error)\n\t\t\t);\n\t\t\t//endregion\n\t\t\t\n\t\t\t//region Append all neccessary data to current CMS_RECIPIENT_INFO object\n\t\t\tcurrentSequence = currentSequence.then(result =>\n\t\t\t{\n\t\t\t\t//region RecipientEncryptedKey\n\t\t\t\t_this.recipientInfos[index].value.encryptedKey = new asn1js.OctetString({ valueHex: result });\n\t\t\t\t//endregion\n\t\t\t}, error =>\n\t\t\t\tPromise.reject(error)\n\t\t\t);\n\t\t\t//endregion\n\t\t\t\n\t\t\treturn currentSequence;\n\t\t}\n\t\t\n\t\tfunction SubKEKRecipientInfo(index)\n\t\t{\n\t\t\t//region Initial variables\n\t\t\tlet currentSequence = Promise.resolve();\n\t\t\tlet kekAlgorithm;\n\t\t\t//endregion\n\t\t\t\n\t\t\t//region Import KEK from pre-defined data\n\t\t\tcurrentSequence = currentSequence.then(() =>\n\t\t\t{\n\t\t\t\t//region Get WebCrypto form of \"keyEncryptionAlgorithm\"\n\t\t\t\tkekAlgorithm = getAlgorithmByOID(_this.recipientInfos[index].value.keyEncryptionAlgorithm.algorithmId);\n\t\t\t\tif((\"name\" in kekAlgorithm) === false)\n\t\t\t\t\treturn Promise.reject(`Incorrect OID for \"keyEncryptionAlgorithm\": ${_this.recipientInfos[index].value.keyEncryptionAlgorithm.algorithmId}`);\n\t\t\t\t\t//endregion\n\t\t\t\t\t\n\t\t\t\treturn crypto.importKey(\"raw\",\n\t\t\t\t\tnew Uint8Array(_this.recipientInfos[index].value.preDefinedKEK),\n\t\t\t\t\tkekAlgorithm,\n\t\t\t\t\ttrue,\n\t\t\t\t\t[\"wrapKey\"]); // Too specific for AES-KW\n\t\t\t}, error =>\n\t\t\t\tPromise.reject(error)\n\t\t\t);\n\t\t\t//endregion\n\t\t\t\n\t\t\t//region Wrap previously exported session key\n\t\t\tcurrentSequence = currentSequence.then(result =>\n\t\t\t\tcrypto.wrapKey(\"raw\", sessionKey, result, kekAlgorithm),\n\t\t\terror =>\n\t\t\t\tPromise.reject(error)\n\t\t\t);\n\t\t\t//endregion\n\t\t\t//region Append all neccessary data to current CMS_RECIPIENT_INFO object\n\t\t\tcurrentSequence = currentSequence.then(result =>\n\t\t\t{\n\t\t\t\t//region RecipientEncryptedKey\n\t\t\t\t_this.recipientInfos[index].value.encryptedKey = new asn1js.OctetString({ valueHex: result });\n\t\t\t\t//endregion\n\t\t\t}, error =>\n\t\t\t\tPromise.reject(error)\n\t\t\t);\n\t\t\t//endregion\n\t\t\t\n\t\t\treturn currentSequence;\n\t\t}\n\t\t\n\t\tfunction SubPasswordRecipientinfo(index)\n\t\t{\n\t\t\t//region Initial variables\n\t\t\tlet currentSequence = Promise.resolve();\n\t\t\tlet pbkdf2Params;\n\t\t\tlet kekAlgorithm;\n\t\t\t//endregion\n\t\t\t\n\t\t\t//region Check that we have encoded \"keyDerivationAlgorithm\" plus \"PBKDF2_params\" in there\n\t\t\tcurrentSequence = currentSequence.then(() =>\n\t\t\t{\n\t\t\t\tif((\"keyDerivationAlgorithm\" in _this.recipientInfos[index].value) === false)\n\t\t\t\t\treturn Promise.reject(\"Please append encoded \\\"keyDerivationAlgorithm\\\"\");\n\t\t\t\t\t\n\t\t\t\tif((\"algorithmParams\" in _this.recipientInfos[index].value.keyDerivationAlgorithm) === false)\n\t\t\t\t\treturn Promise.reject(\"Incorrectly encoded \\\"keyDerivationAlgorithm\\\"\");\n\t\t\t\t\t\n\t\t\t\ttry\n\t\t\t\t{\n\t\t\t\t\tpbkdf2Params = new PBKDF2Params({ schema: _this.recipientInfos[index].value.keyDerivationAlgorithm.algorithmParams });\n\t\t\t\t}\n\t\t\t\tcatch(ex)\n\t\t\t\t{\n\t\t\t\t\treturn Promise.reject(\"Incorrectly encoded \\\"keyDerivationAlgorithm\\\"\");\n\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\treturn Promise.resolve();\n\t\t\t}, error =>\n\t\t\t\tPromise.reject(error)\n\t\t\t);\n\t\t\t//endregion\n\t\t\t//region Derive PBKDF2 key from \"password\" buffer\n\t\t\tcurrentSequence = currentSequence.then(() =>\n\t\t\t{\n\t\t\t\tconst passwordView = new Uint8Array(_this.recipientInfos[index].value.password);\n\t\t\t\t\t\n\t\t\t\treturn crypto.importKey(\"raw\",\n\t\t\t\t\tpasswordView,\n\t\t\t\t\t\"PBKDF2\",\n\t\t\t\t\tfalse,\n\t\t\t\t\t[\"deriveKey\"]);\n\t\t\t}, error =>\n\t\t\t\tPromise.reject(error)\n\t\t\t);\n\t\t\t//endregion\n\t\t\t//region Derive key for \"keyEncryptionAlgorithm\"\n\t\t\tcurrentSequence = currentSequence.then(result =>\n\t\t\t{\n\t\t\t\t//region Get WebCrypto form of \"keyEncryptionAlgorithm\"\n\t\t\t\tkekAlgorithm = getAlgorithmByOID(_this.recipientInfos[index].value.keyEncryptionAlgorithm.algorithmId);\n\t\t\t\tif((\"name\" in kekAlgorithm) === false)\n\t\t\t\t\treturn Promise.reject(`Incorrect OID for \"keyEncryptionAlgorithm\": ${_this.recipientInfos[index].value.keyEncryptionAlgorithm.algorithmId}`);\n\t\t\t\t//endregion\n\t\t\t\t\n\t\t\t\t//region Get HMAC hash algorithm\n\t\t\t\tlet hmacHashAlgorithm = \"SHA-1\";\n\t\t\t\t\t\n\t\t\t\tif(\"prf\" in pbkdf2Params)\n\t\t\t\t{\n\t\t\t\t\tconst algorithm = getAlgorithmByOID(pbkdf2Params.prf.algorithmId);\n\t\t\t\t\tif((\"name\" in algorithm) === false)\n\t\t\t\t\t\treturn Promise.reject(\"Incorrect OID for HMAC hash algorithm\");\n\t\t\t\t\t\t\n\t\t\t\t\thmacHashAlgorithm = algorithm.hash.name;\n\t\t\t\t}\n\t\t\t\t//endregion\n\t\t\t\t\n\t\t\t\t//region Get PBKDF2 \"salt\" value\n\t\t\t\tconst saltView = new Uint8Array(pbkdf2Params.salt.valueBlock.valueHex);\n\t\t\t\t//endregion\n\t\t\t\t\t\n\t\t\t\t//region Get PBKDF2 iterations count\n\t\t\t\tconst iterations = pbkdf2Params.iterationCount;\n\t\t\t\t//endregion\n\t\t\t\t\t\n\t\t\t\treturn crypto.deriveKey({\n\t\t\t\t\tname: \"PBKDF2\",\n\t\t\t\t\thash: {\n\t\t\t\t\t\tname: hmacHashAlgorithm\n\t\t\t\t\t},\n\t\t\t\t\tsalt: saltView,\n\t\t\t\t\titerations\n\t\t\t\t},\n\t\t\t\tresult,\n\t\t\t\tkekAlgorithm,\n\t\t\t\ttrue,\n\t\t\t\t[\"wrapKey\"]); // Usages are too specific for KEK algorithm\n\t\t\t}, error =>\n\t\t\t\tPromise.reject(error)\n\t\t\t);\n\t\t\t//endregion\n\t\t\t//region Wrap previously exported session key (Also too specific for KEK algorithm)\n\t\t\tcurrentSequence = currentSequence.then(result =>\n\t\t\t\tcrypto.wrapKey(\"raw\", sessionKey, result, kekAlgorithm),\n\t\t\terror =>\n\t\t\t\tPromise.reject(error)\n\t\t\t);\n\t\t\t//endregion\n\t\t\t//region Append all neccessary data to current CMS_RECIPIENT_INFO object\n\t\t\tcurrentSequence = currentSequence.then(result =>\n\t\t\t{\n\t\t\t\t//region RecipientEncryptedKey\n\t\t\t\t_this.recipientInfos[index].value.encryptedKey = new asn1js.OctetString({ valueHex: result });\n\t\t\t\t//endregion\n\t\t\t}, error =>\n\t\t\t\tPromise.reject(error)\n\t\t\t);\n\t\t\t//endregion\n\t\t\t\n\t\t\treturn currentSequence;\n\t\t}\n\t\t\n\t\t//endregion\n\t\t\n\t\t//region Create special routines for each \"recipient\"\n\t\tsequence = sequence.then(() =>\n\t\t{\n\t\t\tfor(let i = 0; i < this.recipientInfos.length; i++)\n\t\t\t{\n\t\t\t\t//region Initial variables\n\t\t\t\tlet currentSequence = Promise.resolve();\n\t\t\t\t//endregion\n\t\t\t\t\t\n\t\t\t\tswitch(this.recipientInfos[i].variant)\n\t\t\t\t{\n\t\t\t\t\tcase 1: // KeyTransRecipientInfo\n\t\t\t\t\t\tcurrentSequence = SubKeyTransRecipientInfo(i);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 2: // KeyAgreeRecipientInfo\n\t\t\t\t\t\tcurrentSequence = SubKeyAgreeRecipientInfo(i);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 3: // KEKRecipientInfo\n\t\t\t\t\t\tcurrentSequence = SubKEKRecipientInfo(i);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 4: // PasswordRecipientinfo\n\t\t\t\t\t\tcurrentSequence = SubPasswordRecipientinfo(i);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tdefault:\n\t\t\t\t\t\treturn Promise.reject(`Uknown recipient type in array with index ${i}`);\n\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\trecipientsPromises.push(currentSequence);\n\t\t\t}\n\t\t\t\t\n\t\t\treturn Promise.all(recipientsPromises);\n\t\t}, error =>\n\t\t\tPromise.reject(error)\n\t\t);\n\t\t//endregion\n\t\t\n\t\treturn sequence;\n\t}\n\t//**********************************************************************************\n\t/**\n\t * Decrypt existing CMS Enveloped Data content\n\t * @param {number} recipientIndex Index of recipient\n\t * @param {Object} parameters Additional parameters\n\t * @returns {Promise}\n\t */\n\tdecrypt(recipientIndex, parameters)\n\t{\n\t\t//region Initial variables\n\t\tlet sequence = Promise.resolve();\n\t\t\n\t\tconst decryptionParameters = parameters || {};\n\t\t\n\t\tconst _this = this;\n\t\t//endregion\n\t\t\n\t\t//region Check for input parameters\n\t\tif((recipientIndex + 1) > this.recipientInfos.length)\n\t\t\treturn Promise.reject(`Maximum value for \"index\" is: ${this.recipientInfos.length - 1}`);\n\t\t//endregion\n\t\t\n\t\t//region Get a \"crypto\" extension\n\t\tconst crypto = getCrypto();\n\t\tif(typeof crypto === \"undefined\")\n\t\t\treturn Promise.reject(\"Unable to create WebCrypto object\");\n\t\t//endregion\n\t\t\n\t\t//region Special sub-functions to work with each recipient's type\n\t\tfunction SubKeyAgreeRecipientInfo(index)\n\t\t{\n\t\t\t//region Initial variables\n\t\t\tlet currentSequence = Promise.resolve();\n\t\t\t\n\t\t\tlet recipientCurve;\n\t\t\tlet recipientCurveLength;\n\t\t\t\n\t\t\tlet curveOID;\n\t\t\t\n\t\t\tlet ecdhPrivateKey;\n\t\t\t//endregion\n\t\t\t\n\t\t\t//region Get \"namedCurve\" parameter from recipient's certificate\n\t\t\tcurrentSequence = currentSequence.then(() =>\n\t\t\t{\n\t\t\t\tif((\"recipientCertificate\" in decryptionParameters) === false)\n\t\t\t\t\treturn Promise.reject(\"Parameter \\\"recipientCertificate\\\" is mandatory for \\\"KeyAgreeRecipientInfo\\\"\");\n\t\t\t\t\t\n\t\t\t\tif((\"recipientPrivateKey\" in decryptionParameters) === false)\n\t\t\t\t\treturn Promise.reject(\"Parameter \\\"recipientPrivateKey\\\" is mandatory for \\\"KeyAgreeRecipientInfo\\\"\");\n\t\t\t\t\t\n\t\t\t\tconst curveObject = decryptionParameters.recipientCertificate.subjectPublicKeyInfo.algorithm.algorithmParams;\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\tif(curveObject.constructor.blockName() !== asn1js.ObjectIdentifier.blockName())\n\t\t\t\t\treturn Promise.reject(`Incorrect \"recipientCertificate\" for index ${index}`);\n\t\t\t\tcurveOID = curveObject.valueBlock.toString();\n\t\t\t\t\t\n\t\t\t\tswitch(curveOID)\n\t\t\t\t{\n\t\t\t\t\tcase \"1.2.840.10045.3.1.7\":\n\t\t\t\t\t\trecipientCurve = \"P-256\";\n\t\t\t\t\t\trecipientCurveLength = 256;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase \"1.3.132.0.34\":\n\t\t\t\t\t\trecipientCurve = \"P-384\";\n\t\t\t\t\t\trecipientCurveLength = 384;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase \"1.3.132.0.35\":\n\t\t\t\t\t\trecipientCurve = \"P-521\";\n\t\t\t\t\t\trecipientCurveLength = 528;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tdefault:\n\t\t\t\t\t\treturn Promise.reject(`Incorrect curve OID for index ${index}`);\n\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\treturn crypto.importKey(\"pkcs8\",\n\t\t\t\t\tdecryptionParameters.recipientPrivateKey,\n\t\t\t\t\t{\n\t\t\t\t\t\tname: \"ECDH\",\n\t\t\t\t\t\tnamedCurve: recipientCurve\n\t\t\t\t\t},\n\t\t\t\t\ttrue,\n\t\t\t\t\t[\"deriveBits\"]\n\t\t\t\t);\n\t\t\t}, error =>\n\t\t\t\tPromise.reject(error)\n\t\t\t);\n\t\t\t//endregion\n\t\t\t//region Import sender's ephemeral public key\n\t\t\tcurrentSequence = currentSequence.then(result =>\n\t\t\t{\n\t\t\t\tecdhPrivateKey = result;\n\t\t\t\t\t\n\t\t\t\t//region Change \"OriginatorPublicKey\" if \"curve\" parameter absent\n\t\t\t\tif((\"algorithmParams\" in _this.recipientInfos[index].value.originator.value.algorithm) === false)\n\t\t\t\t\t_this.recipientInfos[index].value.originator.value.algorithm.algorithmParams = new asn1js.ObjectIdentifier({ value: curveOID });\n\t\t\t\t//endregion\n\t\t\t\t\n\t\t\t\t//region Create ArrayBuffer with sender's public key\n\t\t\t\tconst buffer = _this.recipientInfos[index].value.originator.value.toSchema().toBER(false);\n\t\t\t\t//endregion\n\t\t\t\t\t\n\t\t\t\treturn crypto.importKey(\"spki\",\n\t\t\t\t\tbuffer,\n\t\t\t\t\t{\n\t\t\t\t\t\tname: \"ECDH\",\n\t\t\t\t\t\tnamedCurve: recipientCurve\n\t\t\t\t\t},\n\t\t\t\t\ttrue,\n\t\t\t\t\t[]);\n\t\t\t}, error =>\n\t\t\t\tPromise.reject(error)\n\t\t\t);\n\t\t\t//endregion\n\t\t\t//region Create shared secret\n\t\t\tcurrentSequence = currentSequence.then(result =>\n\t\t\t\tcrypto.deriveBits({\n\t\t\t\t\tname: \"ECDH\",\n\t\t\t\t\tpublic: result\n\t\t\t\t},\n\t\t\t\tecdhPrivateKey,\n\t\t\t\trecipientCurveLength),\n\t\t\terror =>\n\t\t\t\tPromise.reject(error)\n\t\t\t);\n\t\t\t//endregion\n\t\t\t//region Apply KDF function to shared secret\n\t\t\tcurrentSequence = currentSequence.then(\n\t\t\t\t/**\n\t\t\t\t * @param {ArrayBuffer} result\n\t\t\t\t */\n\t\t\t\tresult =>\n\t\t\t\t{\n\t\t\t\t\t//region Get length of used AES-KW algorithm\n\t\t\t\t\tconst aesKWAlgorithm = new AlgorithmIdentifier({ schema: _this.recipientInfos[index].value.keyEncryptionAlgorithm.algorithmParams });\n\t\t\t\t\t\n\t\t\t\t\tconst KWalgorithm = getAlgorithmByOID(aesKWAlgorithm.algorithmId);\n\t\t\t\t\tif((\"name\" in KWalgorithm) === false)\n\t\t\t\t\t\treturn Promise.reject(`Incorrect OID for key encryption algorithm: ${aesKWAlgorithm.algorithmId}`);\n\t\t\t\t\t\t//endregion\n\t\t\t\t\t\t\n\t\t\t\t\t\t//region Translate AES-KW length to ArrayBuffer\n\t\t\t\t\tlet kwLength = KWalgorithm.length;\n\t\t\t\t\t\n\t\t\t\t\tconst kwLengthBuffer = new ArrayBuffer(4);\n\t\t\t\t\tconst kwLengthView = new Uint8Array(kwLengthBuffer);\n\t\t\t\t\t\n\t\t\t\t\tfor(let j = 3; j >= 0; j--)\n\t\t\t\t\t{\n\t\t\t\t\t\tkwLengthView[j] = kwLength;\n\t\t\t\t\t\tkwLength >>= 8;\n\t\t\t\t\t}\n\t\t\t\t\t//endregion\n\t\t\t\t\t\n\t\t\t\t\t//region Create and encode \"ECC-CMS-SharedInfo\" structure\n\t\t\t\t\tconst eccInfo = new ECCCMSSharedInfo({\n\t\t\t\t\t\tkeyInfo: new AlgorithmIdentifier({\n\t\t\t\t\t\t\talgorithmId: aesKWAlgorithm.algorithmId,\n\t\t\t\t\t\t\t/*\n\t\t\t\t\t\t\t Initially RFC5753 says that AES algorithms have absent parameters.\n\t\t\t\t\t\t\t But since early implementations all put NULL here. Thus, in order to be\n\t\t\t\t\t\t\t \"backward compatible\", index also put NULL here.\n\t\t\t\t\t\t\t */\n\t\t\t\t\t\t\talgorithmParams: new asn1js.Null()\n\t\t\t\t\t\t}),\n\t\t\t\t\t\tentityUInfo: _this.recipientInfos[index].value.ukm,\n\t\t\t\t\t\tsuppPubInfo: new asn1js.OctetString({ valueHex: kwLengthBuffer })\n\t\t\t\t\t});\n\t\t\t\t\t\n\t\t\t\t\tconst encodedInfo = eccInfo.toSchema().toBER(false);\n\t\t\t\t\t//endregion\n\t\t\t\t\t\n\t\t\t\t\t//region Get SHA algorithm used together with ECDH\n\t\t\t\t\tconst ecdhAlgorithm = getAlgorithmByOID(_this.recipientInfos[index].value.keyEncryptionAlgorithm.algorithmId);\n\t\t\t\t\tif((\"name\" in ecdhAlgorithm) === false)\n\t\t\t\t\t\treturn Promise.reject(`Incorrect OID for key encryption algorithm: ${_this.recipientInfos[index].value.keyEncryptionAlgorithm.algorithmId}`);\n\t\t\t\t\t\t//endregion\n\t\t\t\t\t\t\n\t\t\t\t\treturn kdf(ecdhAlgorithm.kdf, result, KWalgorithm.length, encodedInfo);\n\t\t\t\t},\n\t\t\t\terror =>\n\t\t\t\t\tPromise.reject(error)\n\t\t\t);\n\t\t\t//endregion\n\t\t\t//region Import AES-KW key from result of KDF function\n\t\t\tcurrentSequence = currentSequence.then(result =>\n\t\t\t\tcrypto.importKey(\"raw\",\n\t\t\t\t\tresult,\n\t\t\t\t\t{ name: \"AES-KW\" },\n\t\t\t\t\ttrue,\n\t\t\t\t\t[\"unwrapKey\"]),\n\t\t\terror => Promise.reject(error)\n\t\t\t);\n\t\t\t//endregion\n\t\t\t//region Finally unwrap session key\n\t\t\tcurrentSequence = currentSequence.then(result =>\n\t\t\t{\n\t\t\t\t//region Get WebCrypto form of content encryption algorithm\n\t\t\t\tconst contentEncryptionAlgorithm = getAlgorithmByOID(_this.encryptedContentInfo.contentEncryptionAlgorithm.algorithmId);\n\t\t\t\tif((\"name\" in contentEncryptionAlgorithm) === false)\n\t\t\t\t\treturn Promise.reject(`Incorrect \"contentEncryptionAlgorithm\": ${_this.encryptedContentInfo.contentEncryptionAlgorithm.algorithmId}`);\n\t\t\t\t\t//endregion\n\t\t\t\t\t\n\t\t\t\treturn crypto.unwrapKey(\"raw\",\n\t\t\t\t\t_this.recipientInfos[index].value.recipientEncryptedKeys.encryptedKeys[0].encryptedKey.valueBlock.valueHex,\n\t\t\t\t\tresult,\n\t\t\t\t\t{ name: \"AES-KW\" },\n\t\t\t\t\tcontentEncryptionAlgorithm,\n\t\t\t\t\ttrue,\n\t\t\t\t\t[\"decrypt\"]);\n\t\t\t}, error =>\n\t\t\t\tPromise.reject(error)\n\t\t\t);\n\t\t\t//endregion\n\t\t\t\n\t\t\treturn currentSequence;\n\t\t}\n\t\t\n\t\tfunction SubKeyTransRecipientInfo(index)\n\t\t{\n\t\t\t//region Initial variables\n\t\t\tlet currentSequence = Promise.resolve();\n\t\t\t//endregion\n\t\t\t\n\t\t\t//region Import recipient's private key\n\t\t\tcurrentSequence = currentSequence.then(() =>\n\t\t\t{\n\t\t\t\tif((\"recipientPrivateKey\" in decryptionParameters) === false)\n\t\t\t\t\treturn Promise.reject(\"Parameter \\\"recipientPrivateKey\\\" is mandatory for \\\"KeyTransRecipientInfo\\\"\");\n\t\t\t\t\t\n\t\t\t\t//region Get current used SHA algorithm\n\t\t\t\tconst schema = _this.recipientInfos[index].value.keyEncryptionAlgorithm.algorithmParams;\n\t\t\t\tconst rsaOAEPParams = new RSAESOAEPParams({ schema });\n\t\t\t\t\t\n\t\t\t\tconst hashAlgorithm = getAlgorithmByOID(rsaOAEPParams.hashAlgorithm.algorithmId);\n\t\t\t\tif((\"name\" in hashAlgorithm) === false)\n\t\t\t\t\treturn Promise.reject(`Incorrect OID for hash algorithm: ${rsaOAEPParams.hashAlgorithm.algorithmId}`);\n\t\t\t\t//endregion\n\t\t\t\t\t\n\t\t\t\treturn crypto.importKey(\"pkcs8\",\n\t\t\t\t\tdecryptionParameters.recipientPrivateKey,\n\t\t\t\t\t{\n\t\t\t\t\t\tname: \"RSA-OAEP\",\n\t\t\t\t\t\thash: {\n\t\t\t\t\t\t\tname: hashAlgorithm.name\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\ttrue,\n\t\t\t\t\t[\"decrypt\"]);\n\t\t\t}, error =>\n\t\t\t\tPromise.reject(error)\n\t\t\t);\n\t\t\t//endregion\n\t\t\t//region Decrypt encrypted session key\n\t\t\tcurrentSequence = currentSequence.then(result =>\n\t\t\t\tcrypto.decrypt(result.algorithm,\n\t\t\t\t\tresult,\n\t\t\t\t\t_this.recipientInfos[index].value.encryptedKey.valueBlock.valueHex\n\t\t\t\t), error =>\n\t\t\t\tPromise.reject(error)\n\t\t\t);\n\t\t\t//endregion\n\t\t\t//region Import decrypted session key\n\t\t\tcurrentSequence = currentSequence.then(result =>\n\t\t\t{\n\t\t\t\t//region Get WebCrypto form of content encryption algorithm\n\t\t\t\tconst contentEncryptionAlgorithm = getAlgorithmByOID(_this.encryptedContentInfo.contentEncryptionAlgorithm.algorithmId);\n\t\t\t\tif((\"name\" in contentEncryptionAlgorithm) === false)\n\t\t\t\t\treturn Promise.reject(`Incorrect \"contentEncryptionAlgorithm\": ${_this.encryptedContentInfo.contentEncryptionAlgorithm.algorithmId}`);\n\t\t\t\t//endregion\n\t\t\t\t\t\n\t\t\t\treturn crypto.importKey(\"raw\",\n\t\t\t\t\tresult,\n\t\t\t\t\tcontentEncryptionAlgorithm,\n\t\t\t\t\ttrue,\n\t\t\t\t\t[\"decrypt\"]\n\t\t\t\t);\n\t\t\t}, error =>\n\t\t\t\tPromise.reject(error)\n\t\t\t);\n\t\t\t//endregion\n\t\t\t\n\t\t\treturn currentSequence;\n\t\t}\n\t\t\n\t\tfunction SubKEKRecipientInfo(index)\n\t\t{\n\t\t\t//region Initial variables\n\t\t\tlet currentSequence = Promise.resolve();\n\t\t\tlet kekAlgorithm;\n\t\t\t//endregion\n\t\t\t\n\t\t\t//region Import KEK from pre-defined data\n\t\t\tcurrentSequence = currentSequence.then(() =>\n\t\t\t{\n\t\t\t\tif((\"preDefinedData\" in decryptionParameters) === false)\n\t\t\t\t\treturn Promise.reject(\"Parameter \\\"preDefinedData\\\" is mandatory for \\\"KEKRecipientInfo\\\"\");\n\t\t\t\t\t\n\t\t\t\t//region Get WebCrypto form of \"keyEncryptionAlgorithm\"\n\t\t\t\tkekAlgorithm = getAlgorithmByOID(_this.recipientInfos[index].value.keyEncryptionAlgorithm.algorithmId);\n\t\t\t\tif((\"name\" in kekAlgorithm) === false)\n\t\t\t\t\treturn Promise.reject(`Incorrect OID for \"keyEncryptionAlgorithm\": ${_this.recipientInfos[index].value.keyEncryptionAlgorithm.algorithmId}`);\n\t\t\t\t//endregion\n\t\t\t\t\t\n\t\t\t\treturn crypto.importKey(\"raw\",\n\t\t\t\t\tdecryptionParameters.preDefinedData,\n\t\t\t\t\tkekAlgorithm,\n\t\t\t\t\ttrue,\n\t\t\t\t\t[\"unwrapKey\"]); // Too specific for AES-KW\n\t\t\t}, error =>\n\t\t\t\tPromise.reject(error)\n\t\t\t);\n\t\t\t//endregion\n\t\t\t//region Unwrap previously exported session key\n\t\t\tcurrentSequence = currentSequence.then(result =>\n\t\t\t{\n\t\t\t\t//region Get WebCrypto form of content encryption algorithm\n\t\t\t\tconst contentEncryptionAlgorithm = getAlgorithmByOID(_this.encryptedContentInfo.contentEncryptionAlgorithm.algorithmId);\n\t\t\t\tif((\"name\" in contentEncryptionAlgorithm) === false)\n\t\t\t\t\treturn Promise.reject(`Incorrect \"contentEncryptionAlgorithm\": ${_this.encryptedContentInfo.contentEncryptionAlgorithm.algorithmId}`);\n\t\t\t\t//endregion\n\t\t\t\t\t\n\t\t\t\treturn crypto.unwrapKey(\"raw\",\n\t\t\t\t\t_this.recipientInfos[index].value.encryptedKey.valueBlock.valueHex,\n\t\t\t\t\tresult,\n\t\t\t\t\tkekAlgorithm,\n\t\t\t\t\tcontentEncryptionAlgorithm,\n\t\t\t\t\ttrue,\n\t\t\t\t\t[\"decrypt\"]);\n\t\t\t}, error =>\n\t\t\t\tPromise.reject(error)\n\t\t\t);\n\t\t\t//endregion\n\t\t\t\n\t\t\treturn currentSequence;\n\t\t}\n\t\t\n\t\tfunction SubPasswordRecipientinfo(index)\n\t\t{\n\t\t\t//region Initial variables\n\t\t\tlet currentSequence = Promise.resolve();\n\t\t\tlet pbkdf2Params;\n\t\t\tlet kekAlgorithm;\n\t\t\t//endregion\n\t\t\t\n\t\t\t//region Derive PBKDF2 key from \"password\" buffer\n\t\t\tcurrentSequence = currentSequence.then(() =>\n\t\t\t{\n\t\t\t\tif((\"preDefinedData\" in decryptionParameters) === false)\n\t\t\t\t\treturn Promise.reject(\"Parameter \\\"preDefinedData\\\" is mandatory for \\\"KEKRecipientInfo\\\"\");\n\t\t\t\t\t\n\t\t\t\tif((\"keyDerivationAlgorithm\" in _this.recipientInfos[index].value) === false)\n\t\t\t\t\treturn Promise.reject(\"Please append encoded \\\"keyDerivationAlgorithm\\\"\");\n\t\t\t\t\t\n\t\t\t\tif((\"algorithmParams\" in _this.recipientInfos[index].value.keyDerivationAlgorithm) === false)\n\t\t\t\t\treturn Promise.reject(\"Incorrectly encoded \\\"keyDerivationAlgorithm\\\"\");\n\t\t\t\t\t\n\t\t\t\ttry\n\t\t\t\t{\n\t\t\t\t\tpbkdf2Params = new PBKDF2Params({ schema: _this.recipientInfos[index].value.keyDerivationAlgorithm.algorithmParams });\n\t\t\t\t}\n\t\t\t\tcatch(ex)\n\t\t\t\t{\n\t\t\t\t\treturn Promise.reject(\"Incorrectly encoded \\\"keyDerivationAlgorithm\\\"\");\n\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\treturn crypto.importKey(\"raw\",\n\t\t\t\t\tdecryptionParameters.preDefinedData,\n\t\t\t\t\t\"PBKDF2\",\n\t\t\t\t\tfalse,\n\t\t\t\t\t[\"deriveKey\"]);\n\t\t\t}, error =>\n\t\t\t\tPromise.reject(error)\n\t\t\t);\n\t\t\t//endregion\n\t\t\t//region Derive key for \"keyEncryptionAlgorithm\"\n\t\t\tcurrentSequence = currentSequence.then(result =>\n\t\t\t{\n\t\t\t\t//region Get WebCrypto form of \"keyEncryptionAlgorithm\"\n\t\t\t\tkekAlgorithm = getAlgorithmByOID(_this.recipientInfos[index].value.keyEncryptionAlgorithm.algorithmId);\n\t\t\t\tif((\"name\" in kekAlgorithm) === false)\n\t\t\t\t\treturn Promise.reject(`Incorrect OID for \"keyEncryptionAlgorithm\": ${_this.recipientInfos[index].value.keyEncryptionAlgorithm.algorithmId}`);\n\t\t\t\t//endregion\n\t\t\t\t\n\t\t\t\t//region Get HMAC hash algorithm\n\t\t\t\tlet hmacHashAlgorithm = \"SHA-1\";\n\t\t\t\t\t\n\t\t\t\tif(\"prf\" in pbkdf2Params)\n\t\t\t\t{\n\t\t\t\t\tconst algorithm = getAlgorithmByOID(pbkdf2Params.prf.algorithmId);\n\t\t\t\t\tif((\"name\" in algorithm) === false)\n\t\t\t\t\t\treturn Promise.reject(\"Incorrect OID for HMAC hash algorithm\");\n\t\t\t\t\t\t\n\t\t\t\t\thmacHashAlgorithm = algorithm.hash.name;\n\t\t\t\t}\n\t\t\t\t//endregion\n\t\t\t\t\n\t\t\t\t//region Get PBKDF2 \"salt\" value\n\t\t\t\tconst saltView = new Uint8Array(pbkdf2Params.salt.valueBlock.valueHex);\n\t\t\t\t//endregion\n\t\t\t\t\t\n\t\t\t\t//region Get PBKDF2 iterations count\n\t\t\t\tconst iterations = pbkdf2Params.iterationCount;\n\t\t\t\t//endregion\n\t\t\t\t\t\n\t\t\t\treturn crypto.deriveKey({\n\t\t\t\t\tname: \"PBKDF2\",\n\t\t\t\t\thash: {\n\t\t\t\t\t\tname: hmacHashAlgorithm\n\t\t\t\t\t},\n\t\t\t\t\tsalt: saltView,\n\t\t\t\t\titerations\n\t\t\t\t},\n\t\t\t\tresult,\n\t\t\t\tkekAlgorithm,\n\t\t\t\ttrue,\n\t\t\t\t[\"unwrapKey\"]); // Usages are too specific for KEK algorithm\n\t\t\t}, error =>\n\t\t\t\tPromise.reject(error)\n\t\t\t);\n\t\t\t//endregion\n\t\t\t//region Unwrap previously exported session key\n\t\t\tcurrentSequence = currentSequence.then(result =>\n\t\t\t{\n\t\t\t\t//region Get WebCrypto form of content encryption algorithm\n\t\t\t\tconst contentEncryptionAlgorithm = getAlgorithmByOID(_this.encryptedContentInfo.contentEncryptionAlgorithm.algorithmId);\n\t\t\t\tif((\"name\" in contentEncryptionAlgorithm) === false)\n\t\t\t\t\treturn Promise.reject(`Incorrect \"contentEncryptionAlgorithm\": ${_this.encryptedContentInfo.contentEncryptionAlgorithm.algorithmId}`);\n\t\t\t\t\t//endregion\n\t\t\t\t\t\n\t\t\t\treturn crypto.unwrapKey(\"raw\",\n\t\t\t\t\t_this.recipientInfos[index].value.encryptedKey.valueBlock.valueHex,\n\t\t\t\t\tresult,\n\t\t\t\t\tkekAlgorithm,\n\t\t\t\t\tcontentEncryptionAlgorithm,\n\t\t\t\t\ttrue,\n\t\t\t\t\t[\"decrypt\"]);\n\t\t\t}, error =>\n\t\t\t\tPromise.reject(error)\n\t\t\t);\n\t\t\t//endregion\n\t\t\t\n\t\t\treturn currentSequence;\n\t\t}\n\t\t\n\t\t//endregion\n\t\t\n\t\t//region Perform steps, specific to each type of session key encryption\n\t\tsequence = sequence.then(() =>\n\t\t{\n\t\t\t//region Initial variables\n\t\t\tlet currentSequence = Promise.resolve();\n\t\t\t//endregion\n\t\t\t\t\n\t\t\tswitch(this.recipientInfos[recipientIndex].variant)\n\t\t\t{\n\t\t\t\tcase 1: // KeyTransRecipientInfo\n\t\t\t\t\tcurrentSequence = SubKeyTransRecipientInfo(recipientIndex);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 2: // KeyAgreeRecipientInfo\n\t\t\t\t\tcurrentSequence = SubKeyAgreeRecipientInfo(recipientIndex);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 3: // KEKRecipientInfo\n\t\t\t\t\tcurrentSequence = SubKEKRecipientInfo(recipientIndex);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 4: // PasswordRecipientinfo\n\t\t\t\t\tcurrentSequence = SubPasswordRecipientinfo(recipientIndex);\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\treturn Promise.reject(`Uknown recipient type in array with index ${recipientIndex}`);\n\t\t\t}\n\t\t\t\t\n\t\t\treturn currentSequence;\n\t\t}, error =>\n\t\t\tPromise.reject(error)\n\t\t);\n\t\t//endregion\n\t\t\n\t\t//region Finally decrypt data by session key\n\t\tsequence = sequence.then(result =>\n\t\t{\n\t\t\t//region Get WebCrypto form of content encryption algorithm\n\t\t\tconst contentEncryptionAlgorithm = getAlgorithmByOID(this.encryptedContentInfo.contentEncryptionAlgorithm.algorithmId);\n\t\t\tif((\"name\" in contentEncryptionAlgorithm) === false)\n\t\t\t\treturn Promise.reject(`Incorrect \"contentEncryptionAlgorithm\": ${this.encryptedContentInfo.contentEncryptionAlgorithm.algorithmId}`);\n\t\t\t//endregion\n\t\t\t\n\t\t\t//region Get \"intialization vector\" for content encryption algorithm\n\t\t\tconst ivBuffer = this.encryptedContentInfo.contentEncryptionAlgorithm.algorithmParams.valueBlock.valueHex;\n\t\t\tconst ivView = new Uint8Array(ivBuffer);\n\t\t\t//endregion\n\t\t\t\n\t\t\t//region Create correct data block for decryption\n\t\t\tlet dataBuffer = new ArrayBuffer(0);\n\t\t\t\t\n\t\t\tif(this.encryptedContentInfo.encryptedContent.idBlock.isConstructed === false)\n\t\t\t\tdataBuffer = this.encryptedContentInfo.encryptedContent.valueBlock.valueHex;\n\t\t\telse\n\t\t\t{\n\t\t\t\tfor(const content of this.encryptedContentInfo.encryptedContent.valueBlock.value)\n\t\t\t\t\tdataBuffer = utilConcatBuf(dataBuffer, content.valueBlock.valueHex);\n\t\t\t}\n\t\t\t//endregion\n\t\t\t\t\n\t\t\treturn crypto.decrypt({\n\t\t\t\tname: contentEncryptionAlgorithm.name,\n\t\t\t\tiv: ivView\n\t\t\t},\n\t\t\tresult,\n\t\t\tdataBuffer);\n\t\t}, error =>\n\t\t\tPromise.reject(error)\n\t\t);\n\t\t//endregion\n\t\t\n\t\treturn sequence;\n\t}\n\t//**********************************************************************************\n}\n//**************************************************************************************\n"],"file":"EnvelopedData.js"}